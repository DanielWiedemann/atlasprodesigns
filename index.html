<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atlas Pro Designs</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Archivo:wght@900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f4f6fb url('background.webp') repeat;
      background-size: 450px;
      margin: 0;
      padding: 0;
    }
    .atlas-logo {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 32px;
      margin-bottom: 0;
    }
    .atlas-logo img {
      width: 380px;
      max-width: 90%;
      height: auto;
      display: block;
    }
    h1 {
      text-align: center;
      margin-top: 15px;
      color: #000000;
      text-transform: uppercase;
      font-size: 1.6rem;
    }
    .gallery-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }
    .design-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    .design-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    .design-image {
      width: 100%;
      height: 500px;
      object-fit: contain;
      display: block;
      background: #f8f9fa;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      pointer-events: none;
    }
    .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: transparent;
      pointer-events: none;
      z-index: 5;
    }
    .watermark {
      position: absolute;
      bottom: 10px;
      right: 10px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.8rem;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      z-index: 6;
    }
    .design-info {
      padding: 20px;
      text-align: center;
    }
    .design-name {
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 12px;
      line-height: 1.4;
      text-align: center;
    }
    .rating-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .stars {
      display: flex;
      gap: 2px;
      justify-content: center;
    }
    .star {
      color: #ddd;
      cursor: pointer;
      font-size: 2rem;
      transition: color 0.2s;
      font-style: normal;
    }
    .star.filled {
      color: #ffd700;
    }
    .star:hover {
      color: #ffd700;
    }
    .rating-text {
      font-size: 0.9rem;
      color: #666;
    }
    .sold-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .sold-text {
      color: white;
      font-size: 2rem;
      font-weight: bold;
      text-transform: uppercase;
      transform: rotate(-45deg);
      background: rgba(220, 53, 69, 0.9);
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .no-designs {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 1.1rem;
    }
    .admin-link {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #666;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .admin-link:hover {
      background: #555;
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .gallery-container {
        padding: 0 10px;
        width: 95%;
        margin: 20px auto;
      }
      .gallery-grid {
        grid-template-columns: 1fr;
        gap: 16px;
        margin-top: 20px;
      }
      .design-image {
        height: 400px;
      }
      .design-info {
        padding: 15px;
      }
      .design-name {
        font-size: 1rem;
      }
      .star {
        font-size: 1.3rem;
      }
      .admin-link {
        top: 15px;
        right: 15px;
        padding: 6px 10px;
        font-size: 0.7rem;
      }
      h1 {
        font-size: 1.4rem;
        margin-top: 10px;
      }
      .atlas-logo img {
        width: 300px;
      }
    }
  </style>
</head>
<body>
  
  <div class="atlas-logo"><img src="logo.png" alt="Atlas Pro Logo" /></div>
  <h1>Designs Gallery</h1>
  
  <div class="gallery-container">
    <div id="gallery" class="gallery-grid">
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading designs...
      </div>
    </div>
  </div>
  <div id="version-badge" style="position:fixed;bottom:10px;right:10px;z-index:999;background:#e0e0e0;color:#fff;padding:2px 8px;border-radius:6px;font-size:0.85em;font-family:monospace;box-shadow:0 1px 4px rgba(0,0,0,0.04);opacity:0.7;">
    v1.0.19</div>

  <script>
    let supabase = null;
    let SUPABASE_URL = null;
    let SUPABASE_ANON_KEY = null;

    async function loadSupabaseConfig() {
      try {
        const response = await fetch('/api/supabase-config');
        if (response.ok) {
          const config = await response.json();
          SUPABASE_URL = config.supabaseUrl;
          SUPABASE_ANON_KEY = config.supabaseAnonKey;
        } else {
          throw new Error('Failed to load Supabase configuration');
        }
      } catch (error) {
        console.error('Error loading Supabase config:', error);
        document.getElementById('gallery').innerHTML = `
          <div class="no-designs">
            <i class="fas fa-exclamation-triangle"></i><br>
            Error loading Supabase configuration.<br>
            Please check your environment variables.
          </div>
        `;
        return false;
      }
      return true;
    }

    async function initializeSupabase() {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    function getVisitorId() {
      let visitorId = localStorage.getItem('atlas_visitor_id');
      if (!visitorId) {
        visitorId = 'visitor_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('atlas_visitor_id', visitorId);
      }
      return visitorId;
    }

    function createStarRating(designId, avgRating) {
      const container = document.createElement('div');
      container.className = 'rating-container';
      
      const stars = document.createElement('div');
      stars.className = 'stars';
      
      // Get user's previous rating
      const userRating = localStorage.getItem(`rating_${designId}`) || 0;
      
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('i');
        star.className = `star ${i <= userRating ? 'filled' : ''}`;
        star.innerHTML = 'â˜…';
        star.dataset.value = i;
        star.dataset.designId = designId;
        
        star.addEventListener('click', async (e) => {
          e.stopPropagation();
          const rating = parseInt(star.dataset.value);
          const designId = star.dataset.designId;
          
          // Update visual state
          const allStars = stars.querySelectorAll('.star');
          allStars.forEach((s, index) => {
            s.classList.toggle('filled', index < rating);
          });
          
          // Save to localStorage
          localStorage.setItem(`rating_${designId}`, rating);
          
          // Submit to Supabase
          try {
            // First check if a rating already exists for this design and visitor
            const { data: existingRating, error: checkError } = await supabase
              .from('ratings')
              .select('id')
              .eq('design_id', designId)
              .eq('visitor_id', getVisitorId())
              .single();
            
            if (checkError && checkError.code !== 'PGRST116') {
              console.error('Error checking existing rating:', checkError);
              return;
            }
            
            let result;
            if (existingRating) {
              // Update existing rating
              result = await supabase
                .from('ratings')
                .update({ rating: rating })
                .eq('design_id', designId)
                .eq('visitor_id', getVisitorId());
            } else {
              // Insert new rating
              result = await supabase
                .from('ratings')
                .insert({
                  design_id: designId,
                  visitor_id: getVisitorId(),
                  rating: rating
                });
            }
            
            if (result.error) {
              console.error('Error submitting rating:', result.error);
            }
          } catch (error) {
            console.error('Error submitting rating:', error);
          }
        });
        
        // Add hover events for left-to-right filling
        star.addEventListener('mouseenter', () => {
          const allStars = stars.querySelectorAll('.star');
          const starIndex = parseInt(star.dataset.value) - 1;
          allStars.forEach((s, index) => {
            s.style.color = index <= starIndex ? '#ffd700' : '#ddd';
          });
        });
        
        star.addEventListener('mouseleave', () => {
          const allStars = stars.querySelectorAll('.star');
          const userRating = localStorage.getItem(`rating_${designId}`) || 0;
          allStars.forEach((s, index) => {
            s.style.color = index < userRating ? '#ffd700' : '#ddd';
          });
        });
        
        stars.appendChild(star);
      }
      
      container.appendChild(stars);
      
      return container;
    }

    function highlightStars(container, value) {
      const stars = container.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.classList.toggle('filled', index < value);
      });
    }

    async function loadDesigns() {
      try {
        const { data: designs, error } = await supabase
          .from('design_stats')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          throw error;
        }
        
        return designs || [];
      } catch (error) {
        console.error('Error loading designs:', error);
        return [];
      }
    }

    function createDesignCard(design) {
      const card = document.createElement('div');
      card.className = 'design-card';
      card.dataset.designId = design.id;
      
      const image = document.createElement('img');
      image.className = 'design-image';
      image.src = design.image_url;
      image.alt = design.name;
      image.loading = 'lazy';
      
      const info = document.createElement('div');
      info.className = 'design-info';
      
      const name = document.createElement('div');
      name.className = 'design-name';
      name.textContent = design.name;
      
      const rating = createStarRating(design.id, design.average_rating || 0);
      
      info.appendChild(name);
      info.appendChild(rating);
      
      card.appendChild(image);
      card.appendChild(info);
      
      // Add image protection overlay
      const overlay = document.createElement('div');
      overlay.className = 'image-overlay';
      
      // Add watermark
      const watermark = document.createElement('div');
      watermark.className = 'watermark';
      watermark.textContent = '';
      overlay.appendChild(watermark);
      
      card.appendChild(overlay);
      
      // Add SOLD overlay if design is sold
      if (design.is_sold) {
        card.classList.add('sold');
        const overlay = document.createElement('div');
        overlay.className = 'sold-overlay';
        overlay.innerHTML = '<div class="sold-text">SOLD</div>';
        card.appendChild(overlay);
      }
      
      return card;
    }

    async function renderGallery() {
      const designs = await loadDesigns();
      const gallery = document.getElementById('gallery');
      
      if (designs.length === 0) {
        gallery.innerHTML = `
          <div class="no-designs">
            <i class="fas fa-images"></i><br>
            No designs found. Please upload some designs first.
          </div>
        `;
        return;
      }
      
      gallery.innerHTML = '';
      designs.forEach(design => {
        const card = createDesignCard(design);
        gallery.appendChild(card);
      });
    }

    // Initialize
    async function init() {
      await loadSupabaseConfig();
      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        await initializeSupabase();
        await renderGallery();
        setupImageProtection();
      }
    }

    function setupImageProtection() {
      // Prevent right-click context menu on images
      document.addEventListener('contextmenu', function(e) {
        if (e.target.classList.contains('design-image')) {
          e.preventDefault();
          return false;
        }
      });

      // Prevent drag and drop of images
      document.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('design-image')) {
          e.preventDefault();
          return false;
        }
      });

      // Prevent keyboard shortcuts for saving images
      document.addEventListener('keydown', function(e) {
        // Prevent Ctrl+S, Ctrl+Shift+S, F12, Ctrl+U, Ctrl+Shift+I
        if ((e.ctrlKey && (e.key === 's' || e.key === 'u' || e.key === 'i')) || 
            (e.ctrlKey && e.shiftKey && (e.key === 's' || e.key === 'i')) ||
            e.key === 'F12') {
          e.preventDefault();
          return false;
        }
      });

      // Prevent image loading in new tabs
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('design-image')) {
          e.preventDefault();
          return false;
        }
      });
    }

    init();
  </script>
</body>
</html>