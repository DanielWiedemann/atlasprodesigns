<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atlas Pro Designs</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Archivo:wght@900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f4f6fb url('background.webp') repeat;
      background-size: 450px;
      margin: 0;
      padding: 0;
    }
    .atlas-logo {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 32px;
      margin-bottom: 0;
    }
    .atlas-logo img {
      width: 380px;
      max-width: 90%;
      height: auto;
      display: block;
    }
    h1 {
      text-align: center;
      margin-top: 15px;
      color: #000000;
      text-transform: uppercase;
      font-size: 1.6rem;
    }
    .gallery-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }
    .design-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    .design-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    .design-image {
      width: 100%;
      height: 400px;
      max-height: 400px !important;
      object-fit: contain;
      display: block;
      background: #f8f9fa;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      pointer-events: none;
    }
    .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: transparent;
      pointer-events: none;
      z-index: 5;
    }
    .watermark {
      position: absolute;
      bottom: 10px;
      right: 10px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.8rem;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      z-index: 6;
    }
    .design-info {
      padding: 20px;
      text-align: center;
    }
    .design-name {
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 12px;
      line-height: 1.4;
      text-align: center;
    }
    .rating-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .stars {
      display: flex;
      gap: 2px;
      justify-content: center;
    }
    .star {
      color: #ddd;
      cursor: pointer;
      font-size: 3rem;
      transition: color 0.2s;
      font-style: normal;
    }
    .star.filled {
      color: #ffd700;
    }
    .star:hover {
      color: #ffd700;
    }
    .rating-text {
      font-size: 0.9rem;
      color: #666;
    }
    .sold-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .sold-text {
      color: white;
      font-size: 2rem;
      font-weight: bold;
      text-transform: uppercase;
      transform: rotate(-45deg);
      background: rgba(220, 53, 69, 0.9);
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .no-designs {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 1.1rem;
    }
    .admin-link {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #666;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .admin-link:hover {
      background: #555;
    }
    
    /* Filter System Styles */
    .filter-icon {
      position: static;
      display: block;
      background: #3498db;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: background 0.2s;
      margin: 10px 0;
      text-decoration: none;
      text-align: center;
      margin-left: auto;
      margin-right: 20px;
      width: fit-content;
      max-width: 1200px;
    }
    .filter-icon:hover {
      background: #2980b9;
    }
    .filter-icon.active {
      background: #27ae60;
    }
    .filter-panel {
      position: fixed;
      top: 70px;
      right: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      padding: 20px;
      width: 280px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1001;
      display: none;
      border: 1px solid #e0e0e0;
    }
    .filter-panel.show {
      display: block;
    }
    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .filter-header h3 {
      margin: 0;
      font-size: 1rem;
      color: #333;
    }
    .filter-close {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .filter-close:hover {
      color: #333;
    }
    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }
    .filter-tag {
      background: #f8f9fa;
      color: #333;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .filter-tag:hover {
      background: #e9ecef;
    }
    .filter-tag.selected {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    .filter-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .filter-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .filter-apply {
      background: #27ae60;
      color: white;
    }
    .filter-apply:hover {
      background: #229954;
    }
    .filter-clear {
      background: #95a5a6;
      color: white;
    }
    .filter-clear:hover {
      background: #7f8c8d;
    }
    .filter-count {
      font-size: 0.8rem;
      color: #666;
      margin-top: 10px;
      text-align: center;
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .gallery-container {
        padding: 0 10px;
        width: 95%;
        margin: 20px auto;
      }
      .gallery-grid {
        grid-template-columns: 1fr;
        gap: 16px;
        margin-top: 20px;
      }
      .design-image {
        max-height: 500px;
        height: auto;
      }
      .design-info {
        padding: 15px;
      }
      .design-name {
        font-size: 1rem;
      }
      .star {
        font-size: 2.5rem;
      }
      .admin-link {
        top: 15px;
        right: 15px;
        padding: 6px 10px;
        font-size: 0.7rem;
      }
      .filter-icon {
        position: static;
        display: block;
        margin: 10px 0;
        padding: 8px 12px;
        font-size: 0.8rem;
        background: #3498db;
        color: white;
        border-radius: 6px;
        text-decoration: none;
        text-align: center;
        margin-left: auto;
        margin-right: 15px;
        width: fit-content;
      }
      .filter-panel {
        top: 60px;
        right: 15px;
        width: calc(100vw - 30px);
        max-width: 280px;
      }
      h1 {
        font-size: 1.4rem;
        margin-top: 10px;
      }
      .atlas-logo img {
        width: 300px;
      }
    }
  </style>
</head>
<body>
  
  <div class="atlas-logo"><img src="logo.png" alt="Atlas Pro Logo" /></div>
  <h1>Designs Gallery</h1>
  
  <!-- Filter Icon -->
  <div class="filter-icon" id="filterIcon">
    <i class="fas fa-filter"></i> Filter
  </div>
  
  <!-- Filter Panel -->
  <div class="filter-panel" id="filterPanel">
    <div class="filter-header">
      <h3>Filter by Tags</h3>
      <button class="filter-close" id="filterClose">&times;</button>
    </div>
    <div class="filter-tags" id="filterTags">
      <!-- Tags will be loaded here -->
    </div>
    <div class="filter-actions">
      <button class="filter-btn filter-apply" id="filterApply">Apply Filter</button>
      <button class="filter-btn filter-clear" id="filterClear">Clear</button>
    </div>
    <div class="filter-count" id="filterCount">
      Showing all designs
    </div>
  </div>
  
  <div class="gallery-container">
    <div id="gallery" class="gallery-grid">
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading designs...
      </div>
    </div>
  </div>
  <div id="version-badge" style="position:fixed;bottom:10px;right:10px;z-index:999;background:#e0e0e0;color:#fff;padding:2px 8px;border-radius:6px;font-size:0.85em;font-family:monospace;box-shadow:0 1px 4px rgba(0,0,0,0.04);opacity:0.7;">
    v1.0.19</div>
  
  <!-- Jump to Top Button -->
  <button id="jumpToTop" style="position:fixed;bottom:20px;right:20px;z-index:1000;background:rgba(52,152,219,0.8);color:white;border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;font-size:18px;display:none;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(0,0,0,0.2);" onclick="scrollToTop()">
    ↑
  </button>

  <script>
    let supabase = null;
    let SUPABASE_URL = null;
    let SUPABASE_ANON_KEY = null;
    let allDesigns = [];
    let filteredDesigns = [];
    let selectedFilterTags = new Set();
    let allAvailableTags = new Set();

    async function loadSupabaseConfig() {
      try {
        const response = await fetch('/api/supabase-config');
        if (response.ok) {
          const config = await response.json();
          SUPABASE_URL = config.supabaseUrl;
          SUPABASE_ANON_KEY = config.supabaseAnonKey;
        } else {
          throw new Error('Failed to load Supabase configuration');
        }
      } catch (error) {
        console.error('Error loading Supabase config:', error);
        document.getElementById('gallery').innerHTML = `
          <div class="no-designs">
            <i class="fas fa-exclamation-triangle"></i><br>
            Error loading Supabase configuration.<br>
            Please check your environment variables.
          </div>
        `;
        return false;
      }
      return true;
    }

    async function initializeSupabase() {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
    
    // Filter System Functions
    function setupFilterSystem() {
      // Filter icon click
      document.getElementById('filterIcon').addEventListener('click', toggleFilterPanel);
      
      // Filter close button
      document.getElementById('filterClose').addEventListener('click', closeFilterPanel);
      
      // Apply filter button
      document.getElementById('filterApply').addEventListener('click', applyFilter);
      
      // Clear filter button
      document.getElementById('filterClear').addEventListener('click', clearFilter);
      
      // Close panel when clicking outside
      document.addEventListener('click', function(e) {
        const panel = document.getElementById('filterPanel');
        const icon = document.getElementById('filterIcon');
        if (!panel.contains(e.target) && !icon.contains(e.target)) {
          closeFilterPanel();
        }
      });
    }
    
    function toggleFilterPanel() {
      const panel = document.getElementById('filterPanel');
      const icon = document.getElementById('filterIcon');
      
      if (panel.classList.contains('show')) {
        closeFilterPanel();
      } else {
        openFilterPanel();
      }
    }
    
    function openFilterPanel() {
      const panel = document.getElementById('filterPanel');
      const icon = document.getElementById('filterIcon');
      
      panel.classList.add('show');
      icon.classList.add('active');
    }
    
    function closeFilterPanel() {
      const panel = document.getElementById('filterPanel');
      const icon = document.getElementById('filterIcon');
      
      panel.classList.remove('show');
      icon.classList.remove('active');
    }
    
    function loadAvailableTags() {
      // Collect all unique tags from designs
      allAvailableTags.clear();
      allDesigns.forEach(design => {
        if (design.tags && Array.isArray(design.tags)) {
          design.tags.forEach(tag => allAvailableTags.add(tag));
        }
      });
      
      updateFilterTags();
    }
    
    function updateFilterTags() {
      const filterTagsContainer = document.getElementById('filterTags');
      filterTagsContainer.innerHTML = '';
      
      const sortedTags = Array.from(allAvailableTags).sort();
      sortedTags.forEach(tag => {
        const tagElement = document.createElement('div');
        tagElement.className = 'filter-tag';
        tagElement.textContent = tag;
        tagElement.onclick = (e) => {
          e.stopPropagation();
          toggleFilterTag(tag);
        };
        
        if (selectedFilterTags.has(tag)) {
          tagElement.classList.add('selected');
        }
        
        filterTagsContainer.appendChild(tagElement);
      });
    }
    
    function toggleFilterTag(tag) {
      if (selectedFilterTags.has(tag)) {
        selectedFilterTags.delete(tag);
      } else {
        selectedFilterTags.add(tag);
      }
      
      updateFilterTags();
      updateFilterCount();
      // Don't close the panel when selecting tags
    }
    
    function applyFilter() {
      if (selectedFilterTags.size === 0) {
        // Show all designs if no tags selected
        filteredDesigns = [...allDesigns];
      } else {
        // Filter designs that have ANY of the selected tags
        filteredDesigns = allDesigns.filter(design => {
          if (!design.tags || !Array.isArray(design.tags)) return false;
          return design.tags.some(tag => selectedFilterTags.has(tag));
        });
      }
      
      renderGallery();
      updateFilterCount();
      closeFilterPanel(); // Only close when Apply Filter is clicked
    }
    
    function clearFilter() {
      selectedFilterTags.clear();
      filteredDesigns = [...allDesigns];
      updateFilterTags();
      renderGallery();
      updateFilterCount();
      closeFilterPanel();
    }
    
    function updateFilterCount() {
      const filterCount = document.getElementById('filterCount');
      const totalDesigns = allDesigns.length;
      const showingDesigns = filteredDesigns.length;
      
      if (selectedFilterTags.size === 0) {
        filterCount.textContent = `Showing all ${totalDesigns} designs`;
      } else {
        const tagList = Array.from(selectedFilterTags).join(', ');
        filterCount.textContent = `Showing ${showingDesigns} of ${totalDesigns} designs (${tagList})`;
      }
    }

    function getVisitorId() {
      let visitorId = localStorage.getItem('atlas_visitor_id');
      if (!visitorId) {
        visitorId = 'visitor_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('atlas_visitor_id', visitorId);
      }
      return visitorId;
    }

    function createStarRating(designId, avgRating) {
      const container = document.createElement('div');
      container.className = 'rating-container';
      
      const stars = document.createElement('div');
      stars.className = 'stars';
      
      // Get user's previous rating
      const userRating = localStorage.getItem(`rating_${designId}`) || 0;
      
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('i');
        star.className = `star ${i <= userRating ? 'filled' : ''}`;
        star.innerHTML = '★';
        star.dataset.value = i;
        star.dataset.designId = designId;
        
        star.addEventListener('click', async (e) => {
          e.stopPropagation();
          const rating = parseInt(star.dataset.value);
          const designId = star.dataset.designId;
          
          // Update visual state
          const allStars = stars.querySelectorAll('.star');
          allStars.forEach((s, index) => {
            s.classList.toggle('filled', index < rating);
          });
          
          // Save to localStorage
          localStorage.setItem(`rating_${designId}`, rating);
          
          // Submit to Supabase
          try {
            // First check if a rating already exists for this design and visitor
            const { data: existingRating, error: checkError } = await supabase
              .from('ratings')
              .select('id')
              .eq('design_id', designId)
              .eq('visitor_id', getVisitorId())
              .single();
            
            if (checkError && checkError.code !== 'PGRST116') {
              console.error('Error checking existing rating:', checkError);
              return;
            }
            
            let result;
            if (existingRating) {
              // Update existing rating
              result = await supabase
                .from('ratings')
                .update({ rating: rating })
                .eq('design_id', designId)
                .eq('visitor_id', getVisitorId());
            } else {
              // Insert new rating
              result = await supabase
                .from('ratings')
                .insert({
                  design_id: designId,
                  visitor_id: getVisitorId(),
                  rating: rating
                });
            }
            
            if (result.error) {
              console.error('Error submitting rating:', result.error);
            }
          } catch (error) {
            console.error('Error submitting rating:', error);
          }
        });
        
        // Add hover events for left-to-right filling
        star.addEventListener('mouseenter', () => {
          const allStars = stars.querySelectorAll('.star');
          const starIndex = parseInt(star.dataset.value) - 1;
          allStars.forEach((s, index) => {
            s.style.color = index <= starIndex ? '#ffd700' : '#ddd';
          });
        });
        
        star.addEventListener('mouseleave', () => {
          const allStars = stars.querySelectorAll('.star');
          const userRating = localStorage.getItem(`rating_${designId}`) || 0;
          allStars.forEach((s, index) => {
            s.style.color = index < userRating ? '#ffd700' : '#ddd';
          });
        });
        
        stars.appendChild(star);
      }
      
      container.appendChild(stars);
      
      return container;
    }

    function highlightStars(container, value) {
      const stars = container.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.classList.toggle('filled', index < value);
      });
    }

    async function loadDesigns() {
      try {
        const { data: designs, error } = await supabase
          .from('design_stats')
          .select('*, tags')
          .order('created_at', { ascending: false });
        
        if (error) {
          throw error;
        }
        
        return designs || [];
      } catch (error) {
        console.error('Error loading designs:', error);
        return [];
      }
    }

    function createDesignCard(design) {
      const card = document.createElement('div');
      card.className = 'design-card';
      card.dataset.designId = design.id;
      
      const image = document.createElement('img');
      image.className = 'design-image';
      image.src = design.image_url;
      image.alt = design.name;
      image.loading = 'lazy';
      
      const info = document.createElement('div');
      info.className = 'design-info';
      
      const name = document.createElement('div');
      name.className = 'design-name';
      name.textContent = design.name;
      
      const rating = createStarRating(design.id, design.average_rating || 0);
      
      info.appendChild(name);
      info.appendChild(rating);
      
      card.appendChild(image);
      card.appendChild(info);
      
      // Add image protection overlay
      const overlay = document.createElement('div');
      overlay.className = 'image-overlay';
      
      // Add watermark
      const watermark = document.createElement('div');
      watermark.className = 'watermark';
      watermark.textContent = '';
      overlay.appendChild(watermark);
      
      card.appendChild(overlay);
      
      // Add SOLD overlay if design is sold
      if (design.is_sold) {
        card.classList.add('sold');
        const overlay = document.createElement('div');
        overlay.className = 'sold-overlay';
        overlay.innerHTML = '<div class="sold-text">SOLD</div>';
        card.appendChild(overlay);
      }
      
      return card;
    }

    async function renderGallery() {
      const gallery = document.getElementById('gallery');
      
      // Use filtered designs if available, otherwise use all designs
      const designsToShow = filteredDesigns.length > 0 ? filteredDesigns : allDesigns;
      
      if (designsToShow.length === 0) {
        if (allDesigns.length === 0) {
          gallery.innerHTML = `
            <div class="no-designs">
              <i class="fas fa-images"></i><br>
              No designs found. Please upload some designs first.
            </div>
          `;
        } else {
          gallery.innerHTML = `
            <div class="no-designs">
              <i class="fas fa-filter"></i><br>
              No designs match the selected filters.<br>
              <small>Try selecting different tags or clear the filter.</small>
            </div>
          `;
        }
        return;
      }
      
      gallery.innerHTML = '';
      designsToShow.forEach(design => {
        const card = createDesignCard(design);
        gallery.appendChild(card);
      });
    }

    // Initialize
    async function init() {
      await loadSupabaseConfig();
      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        await initializeSupabase();
        
        // Load all designs first
        allDesigns = await loadDesigns();
        filteredDesigns = [...allDesigns];
        
        // Setup filter system
        setupFilterSystem();
        loadAvailableTags();
        updateFilterCount();
        
        // Render gallery
        await renderGallery();
        setupImageProtection();
      }
    }

    function setupImageProtection() {
      // Prevent right-click context menu on images
      document.addEventListener('contextmenu', function(e) {
        if (e.target.classList.contains('design-image')) {
          e.preventDefault();
          return false;
        }
      });

      // Prevent drag and drop of images
      document.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('design-image')) {
          e.preventDefault();
          return false;
        }
      });

      // Prevent keyboard shortcuts for saving images
      document.addEventListener('keydown', function(e) {
        // Prevent Ctrl+S, Ctrl+Shift+S, F12, Ctrl+U, Ctrl+Shift+I
        if ((e.ctrlKey && (e.key === 's' || e.key === 'u' || e.key === 'i')) || 
            (e.ctrlKey && e.shiftKey && (e.key === 's' || e.key === 'i')) ||
            e.key === 'F12') {
          e.preventDefault();
          return false;
        }
      });

      // Prevent image loading in new tabs
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('design-image')) {
          e.preventDefault();
          return false;
        }
      });
    }

    // Jump to Top functionality
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    function setupScrollToTop() {
      const jumpToTopBtn = document.getElementById('jumpToTop');
      
      window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
          jumpToTopBtn.style.display = 'block';
        } else {
          jumpToTopBtn.style.display = 'none';
        }
      });
    }

    init();
    setupScrollToTop();
  </script>
</body>
</html>