<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atlas Pro Designs</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Archivo:wght@900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f4f6fb url('background.webp') repeat;
      background-size: 450px;
      margin: 0;
      padding: 0;
    }
    .atlas-logo {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 32px;
      margin-bottom: 0;
    }
    .atlas-logo img {
      width: 380px;
      max-width: 90%;
      height: auto;
      display: block;
    }
    h1 {
      text-align: center;
      margin-top: 15px;
      color: #000000;
      text-transform: uppercase;
      font-size: 1.6rem;
    }
    .gallery-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }
    .design-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    .design-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    .design-card.sold {
      opacity: 0.8;
    }
    .design-image {
      width: 100%;
      height: 600px;
      object-fit: contain;
      display: block;
      background: #f8f9fa;
    }
    .design-info {
      padding: 20px;
      text-align: center;
    }
    .design-name {
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 12px;
      line-height: 1.4;
      text-align: center;
    }
    .rating-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .stars {
      display: flex;
      gap: 2px;
      justify-content: center;
    }
    .star {
      color: #ddd;
      cursor: pointer;
      font-size: 1.2rem;
      transition: color 0.2s;
      font-style: normal;
    }
    .star.filled {
      color: #ffd700;
    }
    .star:hover {
      color: #ffd700;
    }
    .rating-text {
      font-size: 0.9rem;
      color: #666;
    }
    .sold-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .sold-text {
      color: white;
      font-size: 2rem;
      font-weight: bold;
      text-transform: uppercase;
      transform: rotate(-45deg);
      background: rgba(220, 53, 69, 0.9);
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
    }
    .modal-content {
      margin: auto;
      display: block;
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    .close {
      position: absolute;
      top: 15px;
      right: 35px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #bbb;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .no-designs {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 1.1rem;
    }
    .admin-link {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #666;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .admin-link:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <a href="admin-supabase.html" class="admin-link">
    <i class="fas fa-cog"></i> Admin
  </a>
  
  <div class="atlas-logo"><img src="logo.png" alt="Atlas Pro Logo" /></div>
  <h1>Atlas Pro Designs</h1>
  
  <div class="gallery-container">
    <div id="gallery" class="gallery-grid">
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading designs...
      </div>
    </div>
  </div>

  <!-- Modal for enlarged view -->
  <div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>

  <script>
    let supabase = null;
    let SUPABASE_URL = null;
    let SUPABASE_ANON_KEY = null;

    async function loadSupabaseConfig() {
      try {
        const response = await fetch('/api/supabase-config');
        if (response.ok) {
          const config = await response.json();
          SUPABASE_URL = config.supabaseUrl;
          SUPABASE_ANON_KEY = config.supabaseAnonKey;
        } else {
          throw new Error('Failed to load Supabase configuration');
        }
      } catch (error) {
        console.error('Error loading Supabase config:', error);
        document.getElementById('gallery').innerHTML = `
          <div class="no-designs">
            <i class="fas fa-exclamation-triangle"></i><br>
            Error loading Supabase configuration.<br>
            Please check your environment variables.
          </div>
        `;
        return false;
      }
      return true;
    }

    async function initializeSupabase() {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    function getVisitorId() {
      let visitorId = localStorage.getItem('atlas_visitor_id');
      if (!visitorId) {
        visitorId = 'visitor_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('atlas_visitor_id', visitorId);
      }
      return visitorId;
    }

    function createStarRating(designId, avgRating) {
      const container = document.createElement('div');
      container.className = 'rating-container';
      
      const stars = document.createElement('div');
      stars.className = 'stars';
      
      // Get user's previous rating
      const userRating = localStorage.getItem(`rating_${designId}`) || 0;
      
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('i');
        star.className = `star ${i <= userRating ? 'filled' : ''}`;
        star.innerHTML = 'â˜…';
        star.dataset.value = i;
        star.dataset.designId = designId;
        
        star.addEventListener('click', async (e) => {
          e.stopPropagation();
          const rating = parseInt(star.dataset.value);
          const designId = star.dataset.designId;
          
          // Update visual state
          const allStars = stars.querySelectorAll('.star');
          allStars.forEach((s, index) => {
            s.classList.toggle('filled', index < rating);
          });
          
          // Save to localStorage
          localStorage.setItem(`rating_${designId}`, rating);
          
          // Submit to Supabase
          try {
            const { error } = await supabase
              .from('ratings')
              .upsert({
                design_id: designId,
                visitor_id: getVisitorId(),
                rating: rating
              });
            
            if (error) {
              console.error('Error submitting rating:', error);
            }
          } catch (error) {
            console.error('Error submitting rating:', error);
          }
        });
        
        stars.appendChild(star);
      }
      
      container.appendChild(stars);
      
      if (avgRating > 0) {
        const ratingText = document.createElement('div');
        ratingText.className = 'rating-text';
        ratingText.textContent = `(${avgRating.toFixed(1)} avg)`;
        container.appendChild(ratingText);
      }
      
      return container;
    }

    function highlightStars(container, value) {
      const stars = container.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.classList.toggle('filled', index < value);
      });
    }

    async function loadDesigns() {
      try {
        const { data: designs, error } = await supabase
          .from('design_stats')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          throw error;
        }
        
        return designs || [];
      } catch (error) {
        console.error('Error loading designs:', error);
        return [];
      }
    }

    function createDesignCard(design) {
      const card = document.createElement('div');
      card.className = 'design-card';
      card.dataset.designId = design.id;
      
      const image = document.createElement('img');
      image.className = 'design-image';
      image.src = design.image_url;
      image.alt = design.name;
      image.loading = 'lazy';
      
      const info = document.createElement('div');
      info.className = 'design-info';
      
      const name = document.createElement('div');
      name.className = 'design-name';
      name.textContent = design.name;
      
      const rating = createStarRating(design.id, design.average_rating || 0);
      
      info.appendChild(name);
      info.appendChild(rating);
      
      card.appendChild(image);
      card.appendChild(info);
      
      // Add SOLD overlay if design is sold
      if (design.is_sold) {
        card.classList.add('sold');
        const overlay = document.createElement('div');
        overlay.className = 'sold-overlay';
        overlay.innerHTML = '<div class="sold-text">SOLD</div>';
        card.appendChild(overlay);
      }
      
      // Click to open modal
      card.addEventListener('click', () => {
        openModal(design.image_url, design.name);
      });
      
      return card;
    }

    async function renderGallery() {
      const designs = await loadDesigns();
      const gallery = document.getElementById('gallery');
      
      if (designs.length === 0) {
        gallery.innerHTML = `
          <div class="no-designs">
            <i class="fas fa-images"></i><br>
            No designs found. Please upload some designs first.
          </div>
        `;
        return;
      }
      
      gallery.innerHTML = '';
      designs.forEach(design => {
        const card = createDesignCard(design);
        gallery.appendChild(card);
      });
    }

    // Modal functionality
    function openModal(imageSrc, imageAlt) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modal.style.display = 'block';
      modalImg.src = imageSrc;
      modalImg.alt = imageAlt;
    }

    function closeModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
    }

    function updateModal() {
      const modal = document.getElementById('imageModal');
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal();
        }
      });
    }

    // Initialize
    async function init() {
      await loadSupabaseConfig();
      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        await initializeSupabase();
        await renderGallery();
        updateModal();
      }
    }

    // Close modal with X button
    document.addEventListener('DOMContentLoaded', () => {
      const closeBtn = document.querySelector('.close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
      }
    });

    init();
  </script>
</body>
</html>