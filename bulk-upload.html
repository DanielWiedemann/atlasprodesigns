<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atlas Pro - Bulk Upload</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Archivo:wght@900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f4f6fb url('background.webp') repeat;
      background-size: 450px;
      margin: 0;
      padding: 0;
    }
    .atlas-logo {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 32px;
      margin-bottom: 0;
    }
    .atlas-logo img {
      width: 380px;
      max-width: 90%;
      height: auto;
      display: block;
    }
    h1 {
      text-align: center;
      margin-top: 15px;
      color: #000000;
      text-transform: uppercase;
      font-size: 1.6rem;
    }
    .upload-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .upload-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      padding: 32px;
      margin-bottom: 24px;
    }
    .config-section {
      margin-bottom: 32px;
    }
    .config-section h3 {
      margin-bottom: 16px;
      color: #333;
    }
    .input-group {
      margin-bottom: 16px;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .input-group input:focus {
      outline: none;
      border-color: #3498db;
    }
    
    /* File Upload Styles */
    .file-upload-section {
      margin-bottom: 32px;
    }
    .file-upload-area {
      border: 3px dashed #3498db;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      background: #f8f9fa;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    .file-upload-area:hover {
      background: #e3f2fd;
      border-color: #2980b9;
    }
    .file-upload-area.dragover {
      background: #e3f2fd;
      border-color: #2980b9;
      transform: scale(1.02);
    }
    .file-upload-icon {
      font-size: 3rem;
      color: #3498db;
      margin-bottom: 16px;
    }
    .file-upload-text {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 8px;
    }
    .file-upload-hint {
      font-size: 0.9rem;
      color: #888;
    }
    .file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    .selected-files {
      margin-top: 20px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .selected-files h4 {
      margin: 0 0 12px 0;
      color: #333;
    }
    .file-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .file-item:last-child {
      border-bottom: none;
    }
    .file-name {
      font-size: 0.9rem;
      color: #555;
      flex: 1;
    }
    .file-size {
      font-size: 0.8rem;
      color: #888;
      margin-left: 12px;
    }
    .remove-file {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8rem;
      cursor: pointer;
      margin-left: 8px;
    }
    .remove-file:hover {
      background: #c0392b;
    }
    
    .upload-button {
      background: #3498db;
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }
    .upload-button:hover {
      background: #2980b9;
    }
    .upload-button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }
    .progress-section {
      margin-top: 24px;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .progress-fill {
      height: 100%;
      background: #3498db;
      width: 0%;
      transition: width 0.3s;
    }
    .status-text {
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }
    .preview-section {
      margin-top: 32px;
    }
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .preview-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      border: 2px solid transparent;
    }
    .preview-item.uploaded {
      border-color: #27ae60;
      background: #d4edda;
    }
    .preview-item.error {
      border-color: #e74c3c;
      background: #f8d7da;
    }
    .preview-filename {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 4px;
      word-break: break-all;
    }
    .preview-name {
      font-weight: bold;
      color: #333;
      font-size: 0.9rem;
    }
    .preview-status {
      font-size: 0.75rem;
      margin-top: 4px;
    }
    .preview-status.success {
      color: #27ae60;
    }
    .preview-status.error {
      color: #e74c3c;
    }
    .back-link {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #666;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .manual-config {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 24px;
      margin-top: 24px;
      margin-bottom: 24px;
    }
    .manual-config h3 {
      margin-bottom: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-link">
    <i class="fas fa-arrow-left"></i> Back to Gallery
  </a>
  
  <div class="atlas-logo"><img src="logo.png" alt="Atlas Pro Logo" /></div>
  <h1>Bulk Upload Designs</h1>
  
  <div class="upload-container">
    <div class="upload-card">
      <div class="file-upload-section">
        <h3>Upload Image Files</h3>
        <div class="file-upload-area" id="fileUploadArea">
          <input type="file" class="file-input" id="fileInput" multiple accept=".webp,.png,.jpg,.jpeg" />
          <div class="file-upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <div class="file-upload-text">Drag & drop image files here</div>
          <div class="file-upload-hint">or click to browse files</div>
          <div class="file-upload-hint">Supports: .webp, .png, .jpg, .jpeg</div>
        </div>
        
        <div class="selected-files" id="selectedFiles" style="display: none;">
          <h4>Selected Files (<span id="fileCount">0</span>)</h4>
          <div class="file-list" id="fileList"></div>
        </div>
      </div>
      
      <div class="config-section">
        <h3>Upload Settings</h3>
        <div class="input-group">
          <label for="imageUrlPrefix">Image URL Prefix</label>
          <input type="url" id="imageUrlPrefix" placeholder="https://your-domain.com/designs/" value="https://atlasprodesigns.vercel.app/designs/" />
        </div>
      </div>
      
      <button class="upload-button" id="uploadButton" onclick="startBulkUpload()" disabled>
        <i class="fas fa-upload"></i> Start Bulk Upload
      </button>
      
      <div class="progress-section" id="progressSection" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="status-text" id="statusText">Preparing upload...</div>
      </div>
    </div>
    
    <div class="preview-section" id="previewSection" style="display: none;">
      <h3>Upload Preview</h3>
      <div class="preview-grid" id="previewGrid"></div>
    </div>
  </div>

  <script>
    let selectedFiles = [];
    let uploadedCount = 0;
    let totalCount = 0;
    let SUPABASE_URL = null;
    let SUPABASE_ANON_KEY = null;

    async function loadSupabaseConfig() {
      try {
        const response = await fetch('/api/supabase-config');
        if (response.ok) {
          const config = await response.json();
          SUPABASE_URL = config.supabaseUrl;
          SUPABASE_ANON_KEY = config.supabaseAnonKey;
          console.log('Supabase config loaded from API');
          return true;
        } else {
          throw new Error('API returned ' + response.status);
        }
      } catch (error) {
        console.log('API not available, using manual config');
        // For local development, show manual input fields
        showManualConfig();
        return false;
      }
    }

    function showManualConfig() {
      const configSection = document.querySelector('.config-section');
      const manualConfig = document.createElement('div');
      manualConfig.className = 'manual-config';
      manualConfig.innerHTML = `
        <h3>Supabase Configuration (Local Development)</h3>
        <div class="input-group">
          <label for="manualSupabaseUrl">Supabase URL</label>
          <input type="url" id="manualSupabaseUrl" placeholder="https://your-project.supabase.co" />
        </div>
        <div class="input-group">
          <label for="manualSupabaseKey">Supabase Anon Key</label>
          <input type="text" id="manualSupabaseKey" placeholder="your-anon-key" />
        </div>
        <button class="upload-button" onclick="saveManualConfig()" style="margin-bottom: 16px;">
          <i class="fas fa-save"></i> Save Configuration
        </button>
      `;
      
      // Insert before the existing config section
      configSection.parentNode.insertBefore(manualConfig, configSection);
      
      // Hide the original config section
      configSection.style.display = 'none';
    }

    function saveManualConfig() {
      const url = document.getElementById('manualSupabaseUrl').value.trim();
      const key = document.getElementById('manualSupabaseKey').value.trim();
      
      if (!url || !key) {
        alert('Please enter both Supabase URL and Anon Key');
        return;
      }
      
      SUPABASE_URL = url;
      SUPABASE_ANON_KEY = key;
      
      // Show success message
      const saveButton = document.querySelector('.manual-config .upload-button');
      saveButton.innerHTML = '<i class="fas fa-check"></i> Configuration Saved';
      saveButton.style.background = '#27ae60';
      saveButton.disabled = true;
      
      // Re-enable the upload button if files are selected
      const uploadButton = document.getElementById('uploadButton');
      if (selectedFiles.length > 0) {
        uploadButton.disabled = false;
      }
      
      console.log('Manual Supabase config saved');
    }

    // Extract design name from filename
    function extractDesignName(filename) {
      // Remove file extension
      const nameWithoutExt = filename.replace(/\.(webp|png|jpg|jpeg)$/i, '');
      
      // Split by underscores and get the part after the second underscore
      const parts = nameWithoutExt.split('_');
      if (parts.length >= 3) {
        // Join parts from index 2 onwards (skip date and time)
        let designName = parts.slice(2).join(' ');
        
        // Cut off at the word "simple" (case insensitive)
        const simpleIndex = designName.toLowerCase().indexOf(' simple');
        if (simpleIndex !== -1) {
          designName = designName.substring(0, simpleIndex);
        }
        
        return designName.trim();
      }
      
      // Fallback: remove date/time pattern and clean up
      let fallbackName = nameWithoutExt
        .replace(/^\d{8}_\d{4}_/, '') // Remove date_time_ pattern
        .replace(/_/g, ' ') // Replace underscores with spaces
        .trim();
      
      // Cut off at the word "simple" (case insensitive)
      const simpleIndex = fallbackName.toLowerCase().indexOf(' simple');
      if (simpleIndex !== -1) {
        fallbackName = fallbackName.substring(0, simpleIndex);
      }
      
      return fallbackName.trim();
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function updateFileList() {
      const fileList = document.getElementById('fileList');
      const fileCount = document.getElementById('fileCount');
      const selectedFilesDiv = document.getElementById('selectedFiles');
      const uploadButton = document.getElementById('uploadButton');
      
      fileCount.textContent = selectedFiles.length;
      
      if (selectedFiles.length > 0) {
        selectedFilesDiv.style.display = 'block';
        uploadButton.disabled = false;
        
        fileList.innerHTML = '';
        selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <div class="file-name">${file.name}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
            <button class="remove-file" onclick="removeFile(${index})">
              <i class="fas fa-times"></i>
            </button>
          `;
          fileList.appendChild(fileItem);
        });
      } else {
        selectedFilesDiv.style.display = 'none';
        uploadButton.disabled = true;
      }
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFileList();
    }

    function createPreviewItem(filename, designName) {
      const item = document.createElement('div');
      item.className = 'preview-item';
      item.id = `preview-${filename}`;
      
      item.innerHTML = `
        <div class="preview-filename">${filename}</div>
        <div class="preview-name">${designName}</div>
        <div class="preview-status">Pending</div>
      `;
      
      return item;
    }

    function updatePreviewStatus(filename, status, message = '') {
      const item = document.getElementById(`preview-${filename}`);
      if (item) {
        item.className = `preview-item ${status}`;
        const statusEl = item.querySelector('.preview-status');
        statusEl.textContent = message || status;
        statusEl.className = `preview-status ${status}`;
      }
    }

    async function uploadDesignToSupabase(filename, designName, imageUrl, supabaseUrl, supabaseKey) {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      
      const supabase = createClient(supabaseUrl, supabaseKey);
      
      try {
        const { data, error } = await supabase
          .from('designs')
          .insert({
            filename: filename,
            name: designName,
            image_url: imageUrl,
            is_sold: false
          })
          .select();
        
        if (error) {
          throw error;
        }
        
        return { success: true, data };
      } catch (error) {
        console.error(`Error uploading ${filename}:`, error);
        return { success: false, error: error.message };
      }
    }

    async function startBulkUpload() {
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        alert('Supabase configuration not loaded. Please ensure the API is running.');
        return;
      }
      
      if (selectedFiles.length === 0) {
        alert('Please select files to upload.');
        return;
      }
      
      const imageUrlPrefix = document.getElementById('imageUrlPrefix').value.trim();
      
      if (!imageUrlPrefix) {
        alert('Please enter an Image URL Prefix.');
        return;
      }
      
      // Show progress section
      document.getElementById('progressSection').style.display = 'block';
      document.getElementById('uploadButton').disabled = true;
      
      try {
        totalCount = selectedFiles.length;
        uploadedCount = 0;
        
        // Show preview section
        const previewSection = document.getElementById('previewSection');
        const previewGrid = document.getElementById('previewGrid');
        previewSection.style.display = 'block';
        previewGrid.innerHTML = '';
        
        // Create preview items
        selectedFiles.forEach(file => {
          const designName = extractDesignName(file.name);
          const previewItem = createPreviewItem(file.name, designName);
          previewGrid.appendChild(previewItem);
        });
        
        // Upload files one by one
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const designName = extractDesignName(file.name);
          const imageUrl = `${imageUrlPrefix}${file.name}`;
          
          // Update progress
          const progress = ((i + 1) / totalCount) * 100;
          document.getElementById('progressFill').style.width = `${progress}%`;
          document.getElementById('statusText').textContent = `Uploading ${i + 1} of ${totalCount}: ${designName}`;
          
          // Upload to Supabase
          const result = await uploadDesignToSupabase(file.name, designName, imageUrl, SUPABASE_URL, SUPABASE_ANON_KEY);
          
          if (result.success) {
            uploadedCount++;
            updatePreviewStatus(file.name, 'success', 'Uploaded');
          } else {
            updatePreviewStatus(file.name, 'error', `Error: ${result.error}`);
          }
          
          // Small delay to avoid overwhelming the API
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Final status
        document.getElementById('statusText').textContent = `Upload complete! ${uploadedCount} of ${totalCount} designs uploaded successfully.`;
        document.getElementById('uploadButton').disabled = false;
        document.getElementById('uploadButton').innerHTML = '<i class="fas fa-check"></i> Upload Complete';
        
      } catch (error) {
        console.error('Upload error:', error);
        document.getElementById('statusText').textContent = `Error: ${error.message}`;
        document.getElementById('uploadButton').disabled = false;
      }
    }

    // File upload event handlers
    function setupFileUpload() {
      const fileUploadArea = document.getElementById('fileUploadArea');
      const fileInput = document.getElementById('fileInput');
      
      // Click to upload
      fileUploadArea.addEventListener('click', (e) => {
        // Prevent the click from triggering multiple times
        e.preventDefault();
        e.stopPropagation();
        fileInput.click();
      });
      
      // File input change
      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        selectedFiles = selectedFiles.concat(files);
        updateFileList();
        fileInput.value = ''; // Reset input
      });
      
      // Prevent file input from triggering upload area click
      fileInput.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      // Drag and drop
      fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
      });
      
      fileUploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
      });
      
      fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        const imageFiles = files.filter(file => 
          file.type.startsWith('image/') && 
          /\.(webp|png|jpg|jpeg)$/i.test(file.name)
        );
        
        selectedFiles = selectedFiles.concat(imageFiles);
        updateFileList();
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadSupabaseConfig();
      setupFileUpload();
    });
  </script>
</body>
</html>